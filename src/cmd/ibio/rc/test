#! /usr/local/plan9/bin/rc -e

fn ok_diff {
    nm=$1; prog=$2
    shift; shift
    echo $nm
    if (! ./o.ibio ./test-gslib ./test-gslib/$prog $* > ./test-results/$prog^-actual >[2] ./test-results/$prog^-errors) {
        echo $prog 'failed; should have succeeded' >[1=2]
        cat ./test-results/$prog^-errors >[1=2]
        cat ./test-results/$prog^-actual >[1=2]
        exit 1
    }
    if (! diff ./test-results/$prog^-actual ./test-results/$prog^-expected) {
        echo $prog 'produced incorrect output' >[1=2]
        echo '--- Actual ---' >[1=2]
        cat ./test-results/$prog^-errors >[1=2]
        cat ./test-results/$prog^-actual >[1=2]
        echo '--- Expected ---' >[1=2]
        cat ./test-results/$prog^-expected
        exit 1
    }
    true
}

echo '-- undefined entry points --'
if (./$O.ibio ./test-gslib ./test-gslib/undef-api.ags >[2] ./test-results/undef-api.ags-actual) {
    echo 'ibio succeeded; should have failed' >[1=2]
    exit 1
}
if (! grep -s './test-gslib/undef-api.ags:5: undefined' ./test-results/undef-api.ags-actual) {
    echo 'Couldn''t find expected error message in output anywhere' >[1=2]
    cat ./test-results/undef-api.ags-actual >[1=2]
    exit 1
}
echo

echo '-- entry points that don''t use the newtype wrapper --'
if (./$O.ibio ./test-gslib ./test-gslib/wrong-type.ags >[2] ./test-results/wrong-type.ags-actual) {
    echo 'ibio succeeded; should have failed' >[1=2]
    exit 1
}
if (! grep -s './test-gslib/wrong-type.ags: Bad type' ./test-results/wrong-type.ags-actual) {
    echo 'Couldn''t find expected error message in output anywhere' >[1=2]
    cat ./test-results/wrong-type.ags-actual >[1=2]
    exit 1
}
echo

ok_diff '-- Hello, world --' hello.ibio.ags
ok_diff '-- echo command --' echo.ibio.ags Hello world
