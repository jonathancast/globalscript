< $PLAN9/src/mkhdr

< $GLOBALSCRIPT/src/mkhdr

CFLAGS=$CFLAGS -I $SYSTEM

OFILES=\
	gsmain.$O \
	gsfatal.$O \
	gsoptions.$O \
	apithread.$O \
	eval.$O \
	load.$O \
	inputalloc.$O \
	alloc.$O \
	eval.$O \
	ace.$O \
	symtable.$O \
	bytecompile.$O \
	primset.$O \
	typealloc.$O \
	typecheck.$O \
	clienttypecheck.$O \
	clienttypes.$O \
	clientexpr.$O \
	bctopsort.$O \
	gsrpc.$O \
	regtables.$O \
	runes.$O \
	naturals.$O \
	iochan.$O \
	iostat.$O \
	stringbuilder.$O \
	$SYSTEM/lock.$O \
	$SYSTEM/$CPU/tas.$O \
	$SYSTEM/gssysthreads.$O \
	$SYSTEM/iodir.$O \
	$SYSTEM/iosysconstants.$O \
	$SYSTEM/ioenv.$O \

TEST_OFILES=\
	test.$O \
	test_macros.$O \
	test_load.$O \
	test_symtable.$O \
	test_typealloc.$O \
	test_clienttypecheck.$O \
	$SYSTEM/test.$O \
	test_iostat.$O \
	$SYSTEM/test_iodir.$O \
	test_iochan.$O \

TEST_GSI_OFILES=\
	test-gsi.$O \

TEST_GSEXEC_OFILES=\
	test-gsexec.$O \

LIB=libglobalscript.a

all: $GLOBALSCRIPT/lib/$LIB

$GLOBALSCRIPT/lib/$LIB(%):N: %
$GLOBALSCRIPT/lib/$LIB:	${OFILES:%=$GLOBALSCRIPT/lib/$LIB(%)}
	$AR rsc $GLOBALSCRIPT/lib/$LIB $newmember

&:n:	&.$O
	$AR rsc $GLOBALSCRIPT/lib/$LIB $stem.$O

%.$O: $GLOBALSCRIPT/include/libglobalscript.h
gsmain.$O: gsinputfile.h gssetup.h gsregtables.h ace.h
load.$O: gsinputalloc.h gsinputfile.h gsbytecompile.h gsregtables.h gstopsort.h gstypealloc.h gstypecheck.h gstypecheck.h ace.h
inputalloc.$O: gsinputfile.h gsinputalloc.h
alloc.$O: gsalloc.h
eval.$O: gsheap.h gsinputfile.h gsregtables.h ace.h
ace.$O: gsheap.h gsbytecode.h gsregtables.h ace.h
apithread.$O: gsregtables.h gsbytecode.h api.h
symtable.$O: gsinputfile.h
bytecompile.$O: gsinputfile.h gsregtables.h gstypealloc.h gsbytecompile.h gsheap.h gsbytecode.h gstopsort.h gstypealloc.h
primset.$O: gsinputfile.h gssetup.h gsregtables.h
typealloc.$O: gsinputfile.h gsregtables.h gstypealloc.h gstypecheck.h
typecheck.$O: gsinputfile.h gsregtables.h gstypealloc.h gstypecheck.h
clienttypecheck.$O: gsinputfile.h gstypealloc.h gstypecheck.h
clientexpr.$O: gsinputfile.h gstypealloc.h gstypecheck.h gsheap.h
bctopsort.$O: gsinputfile.h gstopsort.h
regtables.$O: gsinputfile.h gsregtables.h
runes.$O: gsheap.h gssetup.h gsregtables.h ace.h
naturals.$O: gssetup.h
api.$O: api.h
iochan.$O: iofile.h $SYSTEM/iosysconstants.h iomacros.h
iostat.$O: $SYSTEM/iosysconstants.h iofile.h iostat.h iomacros.h
unix/iodir.$O: iofile.h iostat.h iomacros.h unix/iodir.h
unix/ioenv.$O: unix/iosysconstants.h iofile.h

all install:V: test $GLOBALSCRIPT/lib/$LIB

test:V: $O.test
    ./$O.test

integration-test:V: test test-rc

test-rc:V: rc/test $O.test-gsi $O.test-gsexec
    ./rc/test

$O.test:	$TEST_OFILES $GLOBALSCRIPT/lib/$LIB $GLOBALSCRIPT/lib/libtest.a
	$LD -o $target $prereq $LDFLAGS

test.$O: $GLOBALSCRIPT/include/libtest.h test_tests.h $SYSTEM/test_systemtests.h
test_macros.$O: $GLOBALSCRIPT/include/libtest.h test_tests.h
test_symtable.$O: $GLOBALSCRIPT/include/libtest.h gsinputfile.h test_tests.h
test_load.$O: $GLOBALSCRIPT/include/libtest.h test_tests.h
test_typealloc.$O: $GLOBALSCRIPT/include/libtest.h gsinputfile.h gstypealloc.h test_tests.h
test_iostat.$O:	$GLOBALSCRIPT/include/libtest.h $SYSTEM/iosysconstants.h iofile.h iostat.h iomacros.h test_tests.h
test_clienttypecheck.$O: $GLOBALSCRIPT/include/libtest.h gsinputfile.h gstypealloc.h
unix/test_iodir.$O:	$GLOBALSCRIPT/include/libtest.h unix/iosysconstants.h iofile.h iomacros.h unix/iodir.h unix/test_systemtests.h

test-gsi.$O: gsinputfile.h gstypealloc.h

$O.test-gsi:	$TEST_GSI_OFILES $GLOBALSCRIPT/lib/$LIB
	$LD -o $target $prereq $LDFLAGS

%.$O:	%.c
	$CC $CFLAGS -o $target $stem.c

%.$O:	%.s
	$AS $ASFLAGS $stem.s

$O.test-gsexec:	$TEST_GSEXEC_OFILES $GLOBALSCRIPT/lib/$LIB
	$LD -o $target $prereq $LDFLAGS

NUKEFILES=$NUKEFILES $TEST_OFILES $GLOBALSCRIPT/lib/$LIB

< $GLOBALSCRIPT/src/mkcommon
