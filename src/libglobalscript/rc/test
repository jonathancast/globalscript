#! /usr/local/plan9/bin/rc -e

fn ok_diff {
    echo $1
    if (! $2 ./test-gslib ./test-gslib/$3 > ./test-results/$3^-actual >[2] ./test-results/$3^-errors) {
        echo $2 'failed; should have succeeded' >[1=2]
        cat ./test-results/$3^-errors >[1=2]
        cat ./test-results/$3^-actual >[1=2]
        exit 1
    }
    if (! diff ./test-results/$3^-actual ./test-results/$3^-expected) {
        echo $2 'produced incorrect output' >[1=2]
        echo '--- Actual ---' >[1=2]
        cat ./test-results/$3^-errors >[1=2]
        cat ./test-results/$3^-actual >[1=2]
        echo '--- Expected ---' >[1=2]
        cat ./test-results/$3^-expected
        exit 1
    }
    true
}

fn ok_diff_fail {
    echo $1
    if ($2 ./test-gslib ./test-gslib/$3 > ./test-results/$3^-actual >[2] ./test-results/$3^-errors) {
        echo $2 'succeeded; should have failed' >[1=2]
        cat ./test-results/$3^-errors >[1=2]
        cat ./test-results/$3^-actual >[1=2]
        exit 1
    }
    if (! diff ./test-results/$3^-actual ./test-results/$3^-expected) {
        echo $2 'produced incorrect output' >[1=2]
        echo '--- Actual ---' >[1=2]
        cat ./test-results/$3^-errors >[1=2]
        cat ./test-results/$3^-actual >[1=2]
        echo '--- Expected ---' >[1=2]
        cat ./test-results/$3^-expected
        exit 1
    }
    true
}

echo '-- undefined entry points --'
if (./$O.test-gsi ./test-gslib ./test-gslib/undef.ags > ./test-results/undef.ags-actual) {
    echo 'test-gsi succeeded; should have failed' >[1=2]
    exit 1
}
diff ./test-results/undef.ags-actual ./test-results/undef.ags-expected
echo

echo '-- undefined empty record values --'
if (./$O.test-gsi ./test-gslib ./test-gslib/undef-empty-record.ags > ./test-results/undef-empty-record.ags-actual) {
    echo 'test-gsi succeeded; should have failed' >[1=2]
    exit 1
}
diff ./test-results/undef-empty-record.ags-actual ./test-results/undef-empty-record.ags-expected
echo

echo '-- empty record values --'
if (! ./$O.test-gsi ./test-gslib ./test-gslib/empty-record.ags > ./test-results/empty-record.ags-actual) {
    echo 'test-gsi failed; should have succeeded' >[1=2]
    exit 1
}
diff ./test-results/empty-record.ags-actual ./test-results/empty-record.ags-expected
echo

echo '-- empty record expressions --'
if (! ./$O.test-gsi ./test-gslib ./test-gslib/empty-record-expr.ags > ./test-results/empty-record-expr.ags-actual) {
    echo 'test-gsi failed; should have succeeded' >[1=2]
    cat ./test-results/empty-record-expr.ags-actual >[1=2]
    exit 1
}
diff ./test-results/empty-record-expr.ags-actual ./test-results/empty-record-expr.ags-expected
echo

echo '-- undefined expressions --'
if (./$O.test-gsi ./test-gslib ./test-gslib/undef-expr.ags > ./test-results/undef-expr.ags-actual) {
    echo 'test-gsi scuceeded; should have failed' >[1=2]
    exit 1
}
diff ./test-results/undef-expr.ags-actual ./test-results/undef-expr.ags-expected
echo

ok_diff_fail '-- enter undefined polymorphic value --' ./$O.test-gsi enter-polymorphic-undef.ags

echo '-- lambdas with undefined bodies --'
if (! ./$O.test-gsi ./test-gslib ./test-gslib/empty-lambda.ags > ./test-results/empty-lambda.ags-actual) {
    echo 'test-gsi failed; should have succeeded' >[1=2]
    cat ./test-results/empty-lambda.ags-actual
    exit 1;
}
diff ./test-results/empty-lambda.ags-actual ./test-results/empty-lambda.ags-expected
echo

ok_diff '-- lifted lambdas with undefined bodies --' ./$O.test-gsi empty-lifted-lambda.ags

echo '-- undefined values of abstract types --'
if (./$O.test-gsi ./test-gslib ./test-gslib/undef-abs-type.ags > ./test-results/undef-abs-type.ags-actual) {
    echo 'test-gsi succeeded; should have failed' >[1=2]
    exit 1
}
diff ./test-results/undef-abs-type.ags-actual ./test-results/undef-abs-type.ags-expected
echo

echo '-- an abstract type is different from its definition --'
if (./$O.test-gsi ./test-gslib ./test-gslib/invalid-abs-type.ags >[2] ./test-results/invalid-abs-type.ags-actual) {
    echo 'test-gsi succeeded; should have failed' >[1=2]
    cat ./test-results/invalid-abs-type.ags-actual >[1=2]
    exit 1
}
if (! grep -s './test-gslib/invalid-abs-type.ags:[0-9]*: I don''t think' ./test-results/invalid-abs-type.ags-actual) {
    echo 'Couldn''t find expected error message in output anywhere' >[1=2]
    cat ./test-results/invalid-abs-type.ags-actual >[1=2]
    exit 1
}
echo

echo '-- rune literals --'
if (! ./$O.test-gsi ./test-gslib ./test-gslib/rune-literal.ags > ./test-results/rune-literal.ags-actual >[2] ./test-results/rune-literal.ags-errors) {
    echo 'test-gsi failed; should have succeeded' >[1=2]
    cat ./test-results/rune-literal.ags-errors >[1=2]
    cat ./test-results/rune-literal.ags-actual >[1=2]
    exit 1
}
diff ./test-results/rune-literal.ags-actual ./test-results/rune-literal.ags-expected
echo

echo '-- non-empty records --'
if (! ./$O.test-gsi ./test-gslib ./test-gslib/record-literal.ags > ./test-results/record-literal.ags-actual >[2] ./test-results/record-literal.ags-errors) {
    echo 'test-gsi failed; should have succeeded' >[1=2]
    cat ./test-results/record-literal.ags-errors >[1=2]
    cat ./test-results/record-literal.ags-actual >[1=2]
    exit 1
}
diff ./test-results/record-literal.ags-actual ./test-results/record-literal.ags-expected
echo

echo '-- undefined API entry points --'
if (./$O.test-gsexec ./test-gslib ./test-gslib/undef-api.ags >[2] ./test-results/undef-api.ags-actual) {
    echo 'test-gsexec succeeded; should have failed' >[1=2]
    cat ./test-results/undef-api.ags-actual >[1=2]
    exit 1
}
if (! grep -s './test-gslib/undef-api.ags:5: undefined' ./test-results/undef-api.ags-actual) {
    echo 'Couldn''t find expected error message in output anywhere:' >[1=2]
    cat ./test-results/undef-api.ags-actual >[1=2]
    exit 1
}
echo

echo '-- undefined expression API entry points --'
if (./$O.test-gsexec ./test-gslib ./test-gslib/undef-expr-api.ags >[2] ./test-results/undef-expr-api.ags-actual) {
    echo 'test-gsexec succeeded; should have failed' >[1=2]
    cat ./test-results/undef-expr-api.ags-actual >[1=2]
    exit 1
}
if (! grep -s './test-gslib/undef-expr-api.ags:11: undefined' ./test-results/undef-expr-api.ags-actual) {
    echo 'Couldn''t find expected error message in output anywhere:' >[1=2]
    cat ./test-results/undef-expr-api.ags-actual >[1=2]
    exit 1
}
echo

echo '-- block statements with mis-typed bodies --'
if (./$O.test-gsexec ./test-gslib ./test-gslib/mistyped-block-api.ags >[2] ./test-results/mistyped-block-api.ags-actual) {
    echo 'test-gsexec succeeded; should have failed' >[1=2]
    cat ./test-results/mistyped-block-api.ags-actual >[1=2]
    exit 1
}
if (! grep -s './test-gslib/mistyped-block-api.ags:11: I don''t think' ./test-results/mistyped-block-api.ags-actual) {
    echo 'Couldn''t find expected error message in output anywhere:' >[1=2]
    cat ./test-results/mistyped-block-api.ags-actual >[1=2]
    exit 1
}
echo

echo '-- undefined block statement API entry points --'
if (./$O.test-gsexec ./test-gslib ./test-gslib/undef-block-api.ags >[2] ./test-results/undef-block-api.ags-actual) {
    echo 'test-gsexec succeeded; should have failed' >[1=2]
    cat ./test-results/undef-block-api.ags-actual >[1=2]
    exit 1
}
if (! grep -s './test-gslib/undef-block-api.ags:15: undefined' ./test-results/undef-block-api.ags-actual) {
    echo 'Couldn''t find expected error message in output anywhere:' >[1=2]
    cat ./test-results/undef-block-api.ags-actual >[1=2]
    exit 1
}
echo

echo '-- block statement API entry points with mis-typed binds --'
if (./$O.test-gsexec ./test-gslib ./test-gslib/mistyped-bind-api.ags >[2] ./test-results/mistyped-bind-api.ags-actual) {
    echo 'test-gsexec succeeded; should have failed' >[1=2]
    cat ./test-results/mistyped-bind-api.ags-actual >[1=2]
    exit 1
}
if (! grep -s './test-gslib/mistyped-bind-api.ags:11: I don''t think' ./test-results/mistyped-bind-api.ags-actual) {
    echo 'Couldn''t find expected error message in output anywhere:' >[1=2]
    cat ./test-results/mistyped-bind-api.ags-actual >[1=2]
    exit 1
}
echo

echo '-- block statement API entry points with undefined binds --'
if (./$O.test-gsexec ./test-gslib ./test-gslib/undef-bind-api.ags >[2] ./test-results/undef-bind-api.ags-actual) {
    echo 'test-gsexec succeeded; should have failed' >[1=2]
    cat ./test-results/undef-bind-api.ags-actual >[1=2]
    exit 1
}
if (! grep -s './test-gslib/undef-bind-api.ags:17: undefined' ./test-results/undef-bind-api.ags-actual) {
    echo 'Couldn''t find expected error message in output anywhere:' >[1=2]
    cat ./test-results/undef-bind-api.ags-actual >[1=2]
    exit 1
}
echo

echo '-- simple unit statements --'
if (! ./$O.test-gsexec ./test-gslib ./test-gslib/simple-unit-api.ags >[2] ./test-results/simple-unit-api.ags-actual) {
    echo 'test-gsexec failed; should have succeeded' >[1=2]
    cat ./test-results/simple-unit-api.ags-actual >[1=2]
    exit 1
}
echo
