#! /usr/local/plan9/bin/rc -e

. $GLOBALSCRIPT/bin/test-fns

fn ok_diff_fail {
    echo $1
    if ($2 ./test-gslib ./test-gslib/$3 > ./test-results/$3^-actual >[2] ./test-results/$3^-errors) {
        echo $2 'succeeded; should have failed' >[1=2]
        cat ./test-results/$3^-errors >[1=2]
        cat ./test-results/$3^-actual >[1=2]
        exit 1
    }
    if (! diff ./test-results/$3^-actual ./test-results/$3^-expected) {
        echo $2 'produced incorrect output' >[1=2]
        echo '--- Actual ---' >[1=2]
        cat ./test-results/$3^-errors >[1=2]
        cat ./test-results/$3^-actual >[1=2]
        echo '--- Expected ---' >[1=2]
        cat ./test-results/$3^-expected
        exit 1
    }
    true
}

fn ok_grep_errors {
    echo $1
    if ($3 ./test-gslib ./test-gslib/$4 > ./test-results/$4^-actual >[2] ./test-results/$4^-errors) {
        echo $3 'succeeded; should have failed' >[1=2]
        cat ./test-results/$4^-errors >[1=2]
        cat ./test-results/$4^-actual >[1=2]
        exit 1
    }
    if (! grep -s $2 ./test-results/$4^-errors) {
        echo 'Can''t find expected error message in output anywhere' >[1=2]
        cat ./test-results/$4^-errors >[1=2]
        cat ./test-results/$4^-actual >[1=2]
        exit 1
    }
    true
}

echo '-- undefined entry points --'
if (./$O.test-gsi ./test-gslib ./test-gslib/undef.ags > ./test-results/undef.ags-actual) {
    echo 'test-gsi succeeded; should have failed' >[1=2]
    exit 1
}
diff ./test-results/undef.ags-actual ./test-results/undef.ags-expected
echo

echo '-- undefined empty record values --'
if (./$O.test-gsi ./test-gslib ./test-gslib/undef-empty-record.ags > ./test-results/undef-empty-record.ags-actual) {
    echo 'test-gsi succeeded; should have failed' >[1=2]
    exit 1
}
diff ./test-results/undef-empty-record.ags-actual ./test-results/undef-empty-record.ags-expected
echo

echo '-- empty record values --'
if (! ./$O.test-gsi ./test-gslib ./test-gslib/empty-record.ags > ./test-results/empty-record.ags-actual) {
    echo 'test-gsi failed; should have succeeded' >[1=2]
    exit 1
}
diff ./test-results/empty-record.ags-actual ./test-results/empty-record.ags-expected
echo

echo '-- empty record expressions --'
if (! ./$O.test-gsi ./test-gslib ./test-gslib/empty-record-expr.ags > ./test-results/empty-record-expr.ags-actual) {
    echo 'test-gsi failed; should have succeeded' >[1=2]
    cat ./test-results/empty-record-expr.ags-actual >[1=2]
    exit 1
}
diff ./test-results/empty-record-expr.ags-actual ./test-results/empty-record-expr.ags-expected
echo

echo '-- undefined expressions --'
if (./$O.test-gsi ./test-gslib ./test-gslib/undef-expr.ags > ./test-results/undef-expr.ags-actual) {
    echo 'test-gsi scuceeded; should have failed' >[1=2]
    exit 1
}
diff ./test-results/undef-expr.ags-actual ./test-results/undef-expr.ags-expected
echo

ok_diff_fail '-- enter undefined polymorphic value --' ./$O.test-gsi enter-polymorphic-undef.ags
ok_diff '-- yield polymorphic empty lambda --' ./$O.test-gsi yield-polymorphic-empty-lambda.ags

ok_diff '-- lambdas with undefined bodies --' ./$O.test-gsi empty-lambda.ags
ok_diff '-- lifted lambdas with undefined bodies --' ./$O.test-gsi empty-lifted-lambda.ags
ok_diff_fail '-- applying lambdas with undefined bodies --' ./$O.test-gsi apply-empty-lambda.ags

ok_diff_fail '-- let with undefined RHS --' ./$O.test-gsi undef-let.ags
ok_grep_errors '-- a let can be mis-typed --' './test-gslib/mistyped-let.ags:5: I don''t think' ./$O.test-gsi mistyped-let.ags
ok_diff_fail '-- let with undefined FV --' ./$O.test-gsi undef-free-var.ags

ok_diff_fail '-- undefined values of abstract types --' ./$O.test-gsi undef-abs-type.ags
ok_grep_errors '-- an abstract type is different from its definition --' './test-gslib/invalid-abs-type.ags:[0-9]*: I don''t think' ./$O.test-gsi invalid-abs-type.ags

ok_diff '-- rune literals --' ./$O.test-gsi rune-literal.ags
ok_diff '-- non-empty records --' ./$O.test-gsi record-literal.ags
ok_diff '-- constructors --' ./$O.test-gsi constructor.ags
ok_diff '-- constructors with arguments --' ./$O.test-gsi constructor-args.ags
ok_diff '-- string literals --' ./$O.test-gsi string-literal.ags

ok_grep_errors '-- undefined API entry points --' './test-gslib/undef-api.ags:5: undefined' ./$O.test-gsexec undef-api.ags
ok_grep_errors '-- undefined expression API entry points --' './test-gslib/undef-expr-api.ags:11: undefined' ./$O.test-gsexec undef-expr-api.ags
ok_grep_errors '-- block statements with mis-typed bodies --' './test-gslib/mistyped-block-api.ags:11: I don''t think' ./$O.test-gsexec mistyped-block-api.ags
ok_grep_errors '-- undefined block statement API entry points --' './test-gslib/undef-block-api.ags:15: undefined' ./$O.test-gsexec undef-block-api.ags
ok_grep_errors '-- block statement API entry points with mis-typed binds --' './test-gslib/mistyped-bind-api.ags:11: I don''t think' ./$O.test-gsexec mistyped-bind-api.ags
ok_grep_errors '-- block statement API entry points with undefined binds --' './test-gslib/undef-bind-api.ags:17: undefined' ./$O.test-gsexec undef-bind-api.ags

ok_diff '-- simple unit statements --' ./$O.test-gsexec simple-unit-api.ags
ok_diff '-- trivial use of alloc --' ./$O.test-gsexec simple-alloc-api.ags
