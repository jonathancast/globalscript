#! /usr/local/plan9/bin/rc -e

. $GLOBALSCRIPT/bin/test-fns

ok_diff_fail '-- undefined entry points --' ./$O.test-gsi undef.ags
ok_diff_fail '-- undefined empty record values --' ./$O.test-gsi undef-empty-record.ags
ok_diff_fail '-- undefined expressions --' ./$O.test-gsi undef-expr.ags

ok_diff '-- empty record values --' ./$O.test-gsi empty-record.ags
ok_diff '-- empty record expressions --' ./$O.test-gsi empty-record-expr.ags
ok_diff '-- empty lifted record expressions --' ./$O.test-gsi empty-lrecord-expr.ags
ok_diff '-- field extractions --' ./$O.test-gsi field-extraction.ags
ok_diff_fail '-- lazy field extractions --' ./$O.test-gsi lazy-field-extraction.ags
ok_diff_fail '-- lazy field extraction from undefined record --' ./$O.test-gsi lazy-field-extraction-undef-record.ags

ok_diff_fail '-- enter undefined polymorphic value --' ./$O.test-gsi enter-polymorphic-undef.ags
ok_diff '-- yield polymorphic empty lambda --' ./$O.test-gsi yield-polymorphic-empty-lambda.ags

ok_diff_fail '-- force undefined value --' ./$O.test-gsi force-undef.ags
ok_diff_fail '-- force with undefined continuation --' ./$O.test-gsi force-undef-cont.ags

ok_diff_fail '-- strict bind undefined value --' ./$O.test-gsi strict-undef.ags
ok_diff_fail '-- strict with undefined continuation --' ./$O.test-gsi strict-undef-cont.ags

ok_diff '-- lambdas with undefined bodies --' ./$O.test-gsi empty-lambda.ags
ok_diff '-- lifted lambdas with undefined bodies --' ./$O.test-gsi empty-lifted-lambda.ags
ok_diff_fail '-- applying lambdas with undefined bodies --' ./$O.test-gsi apply-empty-lambda.ags
ok_diff '-- partial application of lambda with undefined body --' ./$O.test-gsi partial-apply-empty-lambda.ags
ok_diff_fail '-- over-saturated application of lambda with undefined body --' ./$O.test-gsi over-apply-empty-lamda.ags

ok_diff_fail '-- let with undefined RHS --' ./$O.test-gsi undef-let.ags
ok_grep_errors '-- a let can be mis-typed --' './test-gslib/mistyped-let.ags:5: I don''t think' ./$O.test-gsi mistyped-let.ags
ok_diff_fail '-- let with undefined FV --' ./$O.test-gsi undef-free-var.ags

ok_diff_fail '-- alloc undefined with .undefined --' ./$O.test-gsi undef-op.ags

ok_diff '-- alloc application --' ./$O.test-gsi apply-op.ags

ok_grep_errors '-- abstract types with too few lambdas in definition --' './test-gslib/mis-kinded-abs-type.ags:14: Incorrect kind: ' ./$O.test-gsi mis-kinded-abs-type.ags

ok_diff_fail '-- undefined values of abstract types --' ./$O.test-gsi undef-abs-type.ags
ok_grep_errors '-- an abstract type is different from its definition --' './test-gslib/invalid-abs-type.ags:[0-9]*: I don''t think' ./$O.test-gsi invalid-abs-type.ags

ok_diff_fail '-- undefined abstract type expressions --' ./$O.test-gsi undef-abs-type-expr.ags
ok_grep_errors '-- an abstract type is different from its definition (in expressions) --' './test-gslib/invalid-abs-type-expr.ags:13: I don''t think' ./$O.test-gsi invalid-abs-type-expr.ags

ok_diff_fail '-- force undefined values of abstract types --' ./$O.test-gsi force-undef-abs-type.ags

ok_diff_fail '-- force with free variable in continuation --' ./$O.test-gsi force-with-fv.ags
ok_diff_fail '-- force with free type variable in continuation --' ./$O.test-gsi force-with-type-fv.ags
ok_diff_fail '-- force with free type variable and variable in continuation --' ./$O.test-gsi force-with-fv-and-type-fv.ags

ok_diff '-- rune literals --' ./$O.test-gsi rune-literal.ags
ok_diff '-- two-byte rune literals --' ./$O.test-gsi two-byte-rune-literal.ags
ok_diff '-- three-byte rune literals --' ./$O.test-gsi three-byte-rune-literal.ags
ok_diff '-- non-empty records --' ./$O.test-gsi record-literal.ags
ok_diff '-- constructors --' ./$O.test-gsi constructor.ags
ok_diff '-- constructors with arguments --' ./$O.test-gsi constructor-args.ags
ok_diff '-- constructors with existential type arguments --' ./$O.test-gsi constructor-existential-types.ags
ok_diff '-- string literals --' ./$O.test-gsi string-literal.ags
ok_diff '-- runes in expressions --' ./$O.test-gsi rune-literal-in-expr.ags

ok_diff '-- natural number literals --' ./$O.test-gsi natural-literal.ags
ok_grep_errors '-- natural number literals: letters --' './test-gslib/natural-literal-letter.ags:10: Invalid character ''x'' in natural number literal' ./$O.test-gsi natural-literal-letter.ags
ok_grep_errors '-- natural number literals: negative number --' './test-gslib/natural-literal-negative.ags:10: Invalid character ''-'' in natural number literal' ./$O.test-gsi natural-literal-negative.ags

ok_diff '-- list literals --' ./$O.test-gsi list-literal.ags

ok_diff '-- regex literals --' ./$O.test-gsi regex-literal.ags
ok_diff '-- regex character class --' ./$O.test-gsi regex-class.ags
ok_diff '-- regex negated character class --' ./$O.test-gsi regex-neg-class.ags
ok_diff '-- regex character class ranges --' ./$O.test-gsi regex-class-range.ags
ok_diff '-- regex multi-character classes --' ./$O.test-gsi regex-multi-char-class.ags
ok_diff '-- regex products --' ./$O.test-gsi regex-product.ags
ok_diff '-- regex stars --' ./$O.test-gsi regex-star.ags

ok_diff '-- constructors in expressions --' ./$O.test-gsi constr-in-expr.ags

ok_diff '-- analyze on boxed sums --' ./$O.test-gsi analyze-constructor.ags
ok_diff '-- analyze on sums of unboxed products --' ./$O.test-gsi analyze-adt-constructor.ags
ok_diff '-- analyze with default --' ./$O.test-gsi analyze-default.ags

ok_grep_errors '-- analyze on un-boxed sum with un-bound free type variable --' './test-gslib/ubanalyze-unbound-type-variable.ags:14: Not enough free type variables' ./$O.test-gsi ubanalyze-unbound-type-variable.ags
ok_grep_errors '-- analyze on un-boxed sum with excess free type variable --' './test-gslib/ubanalyze-excess-type-variable.ags:15: Too many free type variables' ./$O.test-gsi ubanalyze-excess-type-variable.ags
ok_grep_errors '-- analyze on un-boxed sum with excess free variable --' './test-gslib/ubanalyze-excess-variable.ags:17: Too many free variables' ./$O.test-gsi ubanalyze-excess-variable.ags

ok_grep_errors '-- analyze on un-boxed sum with mis-matched number of free variables --' './test-gslib/ubanalyze-mismatched-free-variable-number.ags:17: Mis-matched number of free variables' ./$O.test-gsi ubanalyze-mismatched-free-variable-number.ags
ok_grep_errors '-- analyze on un-boxed sum with mis-matched names of free variables --' './test-gslib/ubanalyze-mismatched-free-variable-name.ags:19: Mis-matched free variable' ./$O.test-gsi ubanalyze-mismatched-free-variable-name.ags

ok_diff '-- analyze on un-boxed sums --' ./$O.test-gsi analyze-unboxed-free-variable.ags

ok_grep_errors '-- analyze on existential types with failing occurs check --' './test-gslib/analyze-failing-occurs-check.ags:21: .exkarg-bound type variable Î± free in type of .case body' ./$O.test-gsi analyze-failing-occurs-check.ags
ok_diff_fail '-- analyze on existential types --' ./$O.test-gsi analyze-existential-type.ags

ok_grep_errors '-- undefined API entry points --' './test-gslib/undef-api.ags:5: undefined' ./$O.test-gsexec undef-api.ags
ok_grep_errors '-- undefined expression API entry points --' './test-gslib/undef-expr-api.ags:11: undefined' ./$O.test-gsexec undef-expr-api.ags
ok_grep_errors '-- block statements with mis-typed bodies --' './test-gslib/mistyped-block-api.ags:11: I don''t think' ./$O.test-gsexec mistyped-block-api.ags
ok_grep_errors '-- undefined block statement API entry points --' './test-gslib/undef-block-api.ags:15: undefined' ./$O.test-gsexec undef-block-api.ags
ok_grep_errors '-- block statement API entry points with mis-typed binds --' './test-gslib/mistyped-bind-api.ags:11: I don''t think' ./$O.test-gsexec mistyped-bind-api.ags
ok_grep_errors '-- block statement API entry points with undefined binds --' './test-gslib/undef-bind-api.ags:17: undefined' ./$O.test-gsexec undef-bind-api.ags

ok_diff '-- simple unit statements --' ./$O.test-gsexec simple-unit-api.ags
ok_diff '-- trivial use of alloc --' ./$O.test-gsexec simple-alloc-api.ags

ok_grep_errors '-- API dis-allows .fv free variables for .bind-bound variables of unlifted type --' './test-gslib/invalid-fv.ags:13: ''x'' is .bind-bound but passed for a .fv-bound variable \(should be .efv-bound\)' ./$O.test-gsexec invalid-fv.ags
