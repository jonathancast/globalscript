#! /home/jcast/plan9/bin/awk -f

BEGIN {
    if (!match(ARGV[1], /.threadmain/)) {
        print "FATAL: " ARGV[1] " does not seem to be a valid input filename" >"/dev/stderr"
        exit 1
    } 
    stem = substr(ARGV[1], 1, RSTART - 1);
}

/^%{ *$/, /^%} *$/ {
    if (!match($0, /^%{|^%}/))
        globalpreface = globalpreface "\n" $0
}


END {
    print "/* AUTOMATICALLY GENERATED BY APITHREADCOMPILE"
    print "   DO NOT EDIT OR BEARS WILL EAT YOU */"
    print
    print "#include <u.h>"
    print "#include <libc.h>"
    print "#include <libglobalscript.h>"
    print "#include \"" stem ".h\""
    print
    print globalpreface
    print
    print "void"
    print stem "threadmain(apithreadqueue *q)"
    print "{"
    print "    while(1) {"
    print "        /* qlock(q->lock); */"
    print "        gstypecode tc = gs_get_gsvalue_state(q->curthread->pc->instr);"
    print "        switch (tc) {"
    print "            default:"
    print "                gsfatal(\"Unknown typecode; numeric value %x\\n\", tc);"
    print "        }"
    print "        /* qunlock(q->lock); */"
    print "    }"
    print "}"
}
