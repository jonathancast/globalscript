fn ok_diff {
    nm=$1; prog=$2; script=$3
    shift; shift; shift
    echo $nm
    if (! $prog ./test-gslib ./test-gslib/$script $* > ./test-results/$script^-actual >[2] ./test-results/$script^-errors) {
        echo $prog $script 'failed; should have succeeded' >[1=2]
        cat ./test-results/$script^-errors >[1=2]
        cat ./test-results/$script^-actual >[1=2]
        exit 1
    }
    if (! diff ./test-results/$script^-actual ./test-results/$script^-expected) {
        echo $prog $script 'produced incorrect output' >[1=2]
        echo '--- Actual ---' >[1=2]
        cat ./test-results/$script^-errors >[1=2]
        cat ./test-results/$script^-actual >[1=2]
        echo '--- Expected ---' >[1=2]
        cat ./test-results/$script^-expected
        exit 1
    }
    true
}

fn ok_diff_fail {
    echo $1
    if ($2 ./test-gslib ./test-gslib/$3 > ./test-results/$3^-actual >[2] ./test-results/$3^-errors) {
        echo $2 'succeeded; should have failed' >[1=2]
        cat ./test-results/$3^-errors >[1=2]
        cat ./test-results/$3^-actual >[1=2]
        exit 1
    }
    if (! diff ./test-results/$3^-actual ./test-results/$3^-expected) {
        echo $2 'produced incorrect output' >[1=2]
        echo '--- Actual ---' >[1=2]
        cat ./test-results/$3^-errors >[1=2]
        cat ./test-results/$3^-actual >[1=2]
        echo '--- Expected ---' >[1=2]
        cat ./test-results/$3^-expected
        exit 1
    }
    true
}

fn ok_diff_case {
    nm=$1; shift
    casenm=$1; shift
    prog=$1; shift
    script=$1; shift
    echo $nm
    if (! $prog ./test-gslib ./test-gslib/$script $* > ./test-results/$script^-^$casenm^-actual >[2] ./test-results/$script^-^$casenm^-errors) {
        echo $prog $script 'failed; should have succeeded' >[1=2]
        cat ./test-results/$script^-^$casenm^-errors >[1=2]
        cat ./test-results/$script^-^$casenm^-actual >[1=2]
        exit 1
    }
    if (! diff ./test-results/$script^-^$casenm^-actual ./test-results/$script^-^$casenm^-expected) {
        echo $prog $script 'produced incorrect output' >[1=2]
        echo '--- Actual ---' >[1=2]
        cat ./test-results/$script^-^$casenm^-errors >[1=2]
        cat ./test-results/$script^-^$casenm^-actual >[1=2]
        echo '--- Expected ---' >[1=2]
        cat ./test-results/$script^-^$casenm^-expected
        exit 1
    }
    true
}

fn ok_grep_errors {
    nm=$1; msg=$2; prog=$3; script=$4
    shift; shift; shift; shift
    echo $nm
    if ($prog ./test-gslib ./test-gslib/$script $* > ./test-results/$script^-actual >[2] ./test-results/$script^-errors) {
        echo $prog 'succeeded; should have failed' >[1=2]
        cat ./test-results/$script^-errors >[1=2]
        cat ./test-results/$script^-actual >[1=2]
        exit 1
    }
    if (! grep -s $msg ./test-results/$script^-errors) {
        echo 'Can''t find expected error message '''^$msg^''' in output anywhere' >[1=2]
        cat ./test-results/$script^-errors >[1=2]
        cat ./test-results/$script^-actual >[1=2]
        exit 1
    }
    true
}

fn ok_diff_script {
    nm=$1; casenm=$2
    shift; shift
    echo $nm
    if (! $* > ./test-results/$casenm^-actual >[2] ./test-results/$casenm^-errors) {
        echo $* 'failed; should have succeeded' >[1=2]
        cat ./test-results/$casenm^-errors >[1=2]
        cat ./test-results/$casenm^-actual >[1=2]
        exit 1
    }
    if (! diff ./test-results/$casenm^-actual ./test-results/$casenm^-expected) {
        echo 'Incorrect output:' >[1=2]
        echo '--- Actual ---' >[1=2]
        cat ./test-results/$casenm^-errors >[1=2]
        cat ./test-results/$casenm^-actual >[1=2]
        echo '--- Expected ---' >[1=2]
        cat ./test-results/$casenm^-expected
        exit 1
    }
    true
}

fn ok_grep_script_errors {
    nm = $1; casenm=$2; msg=$3
    shift; shift; shift
    echo $nm
    if ($* > ./test-results/$casenm^-actual >[2] ./test-results/$casenm^-errors) {
        echo $* 'succeeded; should have failed' >[1=2]
        cat ./test-results/$casenm^-errors >[1=2]
        cat ./test-results/$casenm^-actual >[1=2]
        exit 1
    }
    if (! grep -s $msg ./test-results/$casenm^-errors) {
        echo 'Can''t find expected error message '''^$msg^''' in output anywhere' >[1=2]
        cat ./test-results/$casenm^-errors >[1=2]
        cat ./test-results/$casenm^-actual >[1=2]
        exit 1
    }
    true
}
